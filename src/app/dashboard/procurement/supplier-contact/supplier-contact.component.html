<div class="container mt-4">
  <h2>Supplier Management</h2>

  <div *ngIf="message" class="alert alert-info">{{ message }}</div>

  <div class="d-flex justify-content-end mb-3">
    <button class="btn btn-outline-primary me-2"
            (click)="downloadSupplierReportPdf()">
      Supplier Report (PDF)
    </button>

    <button class="btn btn-outline-primary me-2"
            (click)="downloadSupplierReportCsv()">
      Supplier Report (CSV)
    </button>

    <button class="btn btn-primary"
            (click)="openCreateModal()">
      Add Supplier
    </button>
  </div>

  <!-- ===================== SUPPLIER TABLE ===================== -->
  <table class="table table-striped table-hover">
    <thead class="table-dark">
      <tr>
        <th>S.No</th>
        <th>Name</th>
        <th>Contact Person</th>
        <th>Email</th>
        <th>Phone</th>
        <th>Actions</th>
      </tr>
    </thead>

    <tbody>
      <tr *ngFor="let supplier of suppliers; let i = index">
        <td>{{ i + 1 }}</td>
        <td>{{ supplier.suppliersName }}</td>
        <td>{{ supplier.suppliersContactPerson }}</td>
        <td>{{ supplier.suppliersEmail }}</td>
        <td>{{ supplier.suppliersPhone }}</td>

        <td>
          <!-- Edit -->
          <button class="btn btn-sm btn-primary me-2"
                  (click)="selectSupplier(supplier)">
            Edit
          </button>

          <!-- Rate -->
          <button class="btn btn-sm btn-warning me-2"
                  (click)="openRatingModal(supplier.suppliersId)">
            Rate
          </button>

          <!-- Delete -->
          <button class="btn btn-sm btn-danger me-2"
                  (click)="deleteSupplier(supplier.suppliersId)">
            Delete
          </button>

          <!-- PDF Download (single supplier) -->
          <button class="btn btn-sm btn-outline-secondary"
                  (click)="downloadSupplierReportPdfFor(supplier.suppliersId)"
                  title="Download Supplier Report (PDF)">
            <i class="bi bi-file-earmark-pdf"></i>
          </button>
        </td>
      </tr>
    </tbody>
  </table>

  <!-- ===================== EDIT SUPPLIER SECTION ===================== -->
  <div *ngIf="selectedSupplier" class="card mt-4 p-3 shadow-sm">
    <h5>Edit Supplier Contact</h5>

    <div class="row">
      <div class="col-md-4 mb-2">
        <label class="form-label">Contact Person</label>
        <input type="text" class="form-control"
               [(ngModel)]="selectedSupplier.suppliersContactPerson">
      </div>

      <div class="col-md-4 mb-2">
        <label class="form-label">Email</label>
        <input type="email" class="form-control"
               [(ngModel)]="selectedSupplier.suppliersEmail">
      </div>

      <div class="col-md-4 mb-2">
        <label class="form-label">Phone</label>
        <input type="text" class="form-control"
               [(ngModel)]="selectedSupplier.suppliersPhone">
      </div>
    </div>

    <div class="mt-3">
      <button class="btn btn-success me-2" (click)="updateContact()">Save Changes</button>
      <button class="btn btn-secondary" (click)="selectedSupplier = null">Cancel</button>
    </div>
  </div>
  <!-- ===================== END EDIT SECTION ========================== -->

</div>

<!-- ===================== CREATE SUPPLIER MODAL ===================== -->
<div class="modal" tabindex="-1" [ngClass]="{'show d-block': showCreateModal}">
  <div class="modal-dialog">
    <div class="modal-content">

      <div class="modal-header">
        <h5 class="modal-title">Add Supplier</h5>
        <button type="button" class="btn-close" (click)="closeCreateModal()"></button>
      </div>

      <div class="modal-body">
        <form>

          <div class="mb-2">
            <label class="form-label">Supplier Name *</label>
            <input type="text" class="form-control"
                   [(ngModel)]="newSupplier.suppliersName" name="suppliersName">
          </div>

          <div class="mb-2">
            <label class="form-label">Contact Person *</label>
            <input type="text" class="form-control"
                   [(ngModel)]="newSupplier.suppliersContactPerson" name="suppliersContactPerson">
          </div>

          <div class="mb-2">
            <label class="form-label">Email *</label>
            <input type="email" class="form-control"
                   [(ngModel)]="newSupplier.suppliersEmail" name="suppliersEmail">
          </div>

          <div class="mb-2">
            <label class="form-label">Phone *</label>
            <input type="text" class="form-control"
                   [(ngModel)]="newSupplier.suppliersPhone" name="suppliersPhone">
          </div>

          <hr>

          <h6>Address</h6>

          <!-- ***** SINGLE STRING ADDRESS ***** -->
          <div class="mb-2">
            <label class="form-label">Address</label>
            <textarea class="form-control"
                      [(ngModel)]="newSupplier.address"
                      name="address"
                      rows="3"></textarea>
          </div>

        </form>
      </div>

      <div class="modal-footer">
        <button class="btn btn-secondary" (click)="closeCreateModal()">Cancel</button>
        <button class="btn btn-primary" (click)="createSupplier()">Save</button>
      </div>

    </div>
  </div>
</div>

<!-- ===================== RATING MODAL ===================== -->
<div class="modal" tabindex="-1" [ngClass]="{ 'show d-block': showRatingModal }">
  <div class="modal-dialog modal-lg">
    <div class="modal-content">

      <div class="modal-header">
        <h5 class="modal-title">Rate Supplier</h5>
        <button type="button" class="btn-close" (click)="closeRatingModal()"></button>
      </div>

      <!-- ⭐ FULL STAR RATING -->
      <div class="star-rating d-flex justify-content-center mt-3">
        <ng-container *ngFor="let star of [1,2,3,4,5]">
          <i class="bi"
             (mouseover)="setHover(star)"
             (mouseleave)="clearHover()"
             (click)="setRating(star)"
             [ngClass]="getIcon(star)"
             style="font-size: 40px; cursor: pointer; margin: 4px;">
          </i>
        </ng-container>
      </div>

      <div class="modal-body">

        <div class="text-center mt-2">
          <h6>Your Rating: <strong>{{ ratingValue }}</strong></h6>
        </div>

        <div class="mb-3 mt-3">
          <label class="form-label">Comments</label>
          <textarea class="form-control" rows="3"
                    [(ngModel)]="ratingComment"></textarea>
        </div>

        <div class="mt-4">
          <h6>Previous Ratings</h6>

          <ul class="list-group" *ngIf="supplierRatings.length > 0">
            <li class="list-group-item" *ngFor="let r of supplierRatings">
              ⭐ {{ r.ratingValue }} — {{ r.comments }}
              <span class="text-muted">({{ r.ratingDate }})</span>
            </li>
          </ul>

          <p *ngIf="supplierRatings.length === 0" class="text-muted">No ratings yet.</p>
        </div>

      </div>

      <div class="modal-footer">
        <button class="btn btn-secondary" (click)="closeRatingModal()">Cancel</button>
        <button class="btn btn-primary" (click)="submitRating()">Submit Rating</button>
      </div>

    </div>
  </div>
</div>
