<div class="container mt-4" *ngIf="order">
  <h3>Edit Order #{{ order.poId }}</h3>

  <form [formGroup]="updateForm" (ngSubmit)="saveUpdate()">
    <!-- Expected Delivery Date -->
    <div class="mb-3">
      <label>Expected Delivery Date</label>
      <input type="date" class="form-control" formControlName="newExpectedDeliveryDate">
      <div *ngIf="updateForm.get('newExpectedDeliveryDate')?.touched && updateForm.get('newExpectedDeliveryDate')?.invalid" class="text-danger">
        Expected Delivery Date is required
      </div>
    </div>

    <h5>Items</h5>

    <!-- Column Labels -->
    <div class="row mb-2 fw-bold">
      <div class="col-md-3">Product Name</div>
      <div class="col-md-2">Old Quantity</div>
      <div class="col-md-2">New Quantity</div>
      <div class="col-md-2">Action</div>
    </div>

    <div formArrayName="items">
      <div
        class="row mb-2 align-items-center"
        *ngFor="let itemCtrl of itemsFormArray.controls; let i = index"
        [formGroupName]="i"
      >
        <!-- Product Name -->
        <div class="col-md-3">
          <ng-container *ngIf="itemsFormArray.at(i).get('itemId')?.value; else newItemSelect">
            {{ order.items[i]?.productName }}
          </ng-container>
          <ng-template #newItemSelect>
            <select class="form-select">
              <option value="">Select Product</option>
              <option *ngFor="let product of availableProducts" [value]="product.productId">
                {{ product.productName }}
              </option>
            </select>
          </ng-template>
        </div>

        <!-- Old Quantity -->
        <div class="col-md-2">
          <ng-container *ngIf="itemsFormArray.at(i).get('itemId')?.value; else newOldQty">
            <input type="number" class="form-control" [value]="order.items[i]?.quantity || 0" readonly>
          </ng-container>
          <ng-template #newOldQty>
            <input type="number" class="form-control" value="0" readonly>
          </ng-template>
        </div>

        <!-- New Quantity -->
        <div class="col-md-2">
          <input type="number" class="form-control" formControlName="newQuantity">
          <div *ngIf="itemCtrl.get('newQuantity')?.touched && itemCtrl.get('newQuantity')?.invalid" class="text-danger">
            Quantity is required and must be at least 1
          </div>
        </div>

        <!-- Remove Button -->
        <div class="col-md-2">
          <button type="button" class="btn btn-danger" (click)="removeItem(i)">Remove</button>
        </div>
      </div>
    </div>

    <!-- Save / Cancel -->
    <div class="mt-3">
      <button type="submit" class="btn btn-success me-2">Save Changes</button>
      <button type="button" class="btn btn-danger" (click)="cancelOrder()">Cancel Order</button>
    </div>
  </form>
</div>
